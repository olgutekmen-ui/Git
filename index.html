<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vyra: Neo-Seoul Grid Run (v6.5 Skin Fix)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #050510; font-family: 'Courier New', Courier, monospace; color: white; user-select: none; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #000; overflow: hidden; }
        
        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
        }

        #damage-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: red; opacity: 0; pointer-events: none; z-index: 18; transition: opacity 0.1s;
        }

        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: none; }
        .visible { display: block !important; }
        .hud-element { position: absolute; padding: 10px; text-shadow: 0 0 5px #0ff; }
        
        #score-display { top: 20px; left: 20px; font-size: 24px; color: #00ffff; font-weight:bold; letter-spacing: 2px; }
        
        #currency-display { 
            top: 20px; left: 50%; transform: translateX(-50%); 
            font-size: 24px; color: #00ffff; text-shadow: 0 0 5px #00ffff; 
            display: flex; align-items: center; gap: 10px;
        }
        .currency-icon { width: 30px; height: 30px; object-fit: contain; }

        #flow-meter { position: absolute; top: 60px; left: 20px; width: 200px; height: 15px; background: rgba(0,0,0,0.5); border: 2px solid #555; transform: skewX(-20deg); }
        #flow-fill { width: 0%; height: 100%; background: #ff00ff; box-shadow: 0 0 10px #ff00ff; transition: width 0.1s linear; }
        #multiplier-display { top: 20px; right: 20px; font-size: 30px; color: #ff00ff; font-weight: bold; text-shadow: 0 0 10px #ff00ff; }
        
        #district-announcer {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; color: #fff; font-weight: bold; text-align: center;
            text-shadow: 0 0 20px currentColor; opacity: 0; transition: opacity 0.5s;
            pointer-events: none; z-index: 15; width: 100%;
        }
        
        .menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 16, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; pointer-events: auto; overflow-y: auto; }
        
        /* INTRO SPECIFIC */
        #intro-layer { background: #000; z-index: 50; }
        .studio-logo { width: 180px; border-radius: 20px; box-shadow: 0 0 50px cyan; margin-bottom: 20px; animation: glow 3s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 20px #00aaaa; } to { box-shadow: 0 0 60px #00ffff; } }

        h1 { font-size: 40px; color: #00ffff; margin-bottom: 5px; text-shadow: 0 0 20px #00ffff; text-transform: uppercase; letter-spacing: 5px; text-align: center; }
        h2 { font-size: 20px; color: #ffd700; margin: 10px 0; letter-spacing: 2px; display: flex; align-items: center; gap: 10px; }
        h3 { font-size: 16px; color: #fff; margin: 20px 0 10px 0; border-bottom: 1px solid #333; width: 80%; text-align: center; padding-bottom: 5px; }

        .wallet-header { display: flex; gap: 30px; margin: 10px 0; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 10px; border: 1px solid #333; }
        .wallet-item { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: bold; }

        .shop-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; max-width: 800px; padding: 0 20px; }
        
        .shop-item { background: rgba(0, 0, 0, 0.5); border: 1px solid #555; padding: 15px; text-align: center; width: 130px; transition: 0.2s; cursor: pointer; position: relative; }
        .shop-item:hover { border-color: #00ffff; transform: translateY(-3px); }
        .shop-item.premium { border-color: #ffd700; }
        .shop-item.premium:hover { border-color: #fff; box-shadow: 0 0 15px #ffd700; }

        .item-icon { font-size: 30px; margin-bottom: 5px; }
        .item-name { font-size: 12px; font-weight: bold; color: #fff; }
        
        .price-tag { font-weight: bold; margin-top: 5px; font-size: 13px; letter-spacing: 0.5px; }
        .cost-energy { color: #00ffff; text-shadow: 0 0 2px #0000ff; }
        .cost-aurum { color: #ffd700; text-shadow: 0 0 2px #aa6600; }
        .cost-real { color: #00ff00; font-size: 15px; text-shadow: 0 0 2px #006600; }
        .item-desc { font-size: 10px; color: #aaa; margin-top: 5px; text-transform: uppercase; }
        
        button { padding: 15px 50px; font-size: 20px; background: #ff00ff; color: white; border: none; cursor: pointer; box-shadow: 0 0 20px #ff00ff; text-transform: uppercase; font-weight: bold; letter-spacing: 2px; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); transition: transform 0.1s; margin-top: 20px; }
        button:hover { background: #d000d0; transform: scale(1.05); }
        button:disabled { background: #555; cursor: not-allowed; filter: grayscale(100%); }

        .control-toggle { display: flex; gap: 10px; margin-bottom: 10px; }
        .toggle-btn { padding: 5px 15px; border: 1px solid #555; background: rgba(0,0,0,0.5); color: #888; cursor: pointer; font-weight: bold; font-size: 12px; }
        .toggle-btn.active { border-color: #00ffff; color: #00ffff; background: rgba(0, 255, 255, 0.1); }

        #controls-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 12; display: none; }
        .control-btn { position: absolute; width: 80px; height: 80px; background: rgba(0, 255, 255, 0.1); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; font-size: 30px; color: rgba(0, 255, 255, 0.8); user-select: none; -webkit-user-select: none; }
        .control-btn:active { background: rgba(0, 255, 255, 0.4); transform: scale(0.95); }
        #btn-left { bottom: 30px; left: 20px; }
        #btn-right { bottom: 30px; left: 120px; }
        #btn-jump { bottom: 120px; right: 20px; border-color: #00ff00; color: #00ff00; background: rgba(0,255,0,0.1); }
        #btn-slide { bottom: 30px; right: 20px; border-color: #ff00ff; color: #ff00ff; background: rgba(255,0,255,0.1); }

        #turbo-btn { position: absolute; bottom: 200px; right: 20px; width: 60px; height: 60px; border-radius: 50%; border: 2px solid #ffaa00; background: rgba(255, 170, 0, 0.1); color: #ffaa00; font-weight: bold; font-size: 24px; display: flex; align-items: center; justify-content: center; pointer-events: auto; user-select: none; z-index: 20; transition: all 0.1s; }
        #turbo-btn:active, #turbo-btn.active { background: #ffaa00; color: #000; box-shadow: 0 0 20px #ffaa00; transform: scale(0.95); }

        #ability-btn { position: absolute; bottom: 40px; right: 30px; width: 80px; height: 80px; border-radius: 50%; border: 3px solid #00ff00; background: rgba(0, 255, 0, 0.2); color: #00ff00; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; text-align: center; cursor: pointer; pointer-events: auto; box-shadow: 0 0 20px #00ff00; animation: pulse 1s infinite; z-index: 20; }
        @keyframes pulse { 0% { box-shadow: 0 0 10px #00ff00; } 50% { box-shadow: 0 0 30px #00ff00; } 100% { box-shadow: 0 0 10px #00ff00; } }
        
        #tutorial-layer, #leaderboard-layer, #pause-layer { background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 30; }
        .card-panel { border: 2px solid #00ffff; padding: 20px; border-radius: 10px; background: rgba(0,20,20,0.95); width: 90%; max-width: 400px; box-shadow: 0 0 30px #00ffff; text-align: center; }
        .tut-row { display: flex; align-items: center; margin: 15px 0; justify-content: flex-start; gap: 15px; color: #fff; font-size: 16px; text-align: left; }
        .tut-icon { font-size: 24px; width: 40px; text-align: center; color: #ffd700; flex-shrink: 0; }
        #lb-table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #fff; font-size: 14px; }
        #lb-table th { border-bottom: 1px solid #00ffff; color: #00ffff; padding: 5px; text-align: left; }
        #lb-table td { padding: 8px 5px; border-bottom: 1px solid #333; }
        #lb-table tr:first-child td { color: #ffd700; font-weight: bold; }
        #player-name-input { background: #000; border: 1px solid #00ffff; color: #fff; padding: 10px; font-family: 'Courier New', monospace; font-size: 18px; text-align: center; width: 80%; margin-top: 10px; }
        
        #pause-btn-hud { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border: 2px solid #fff; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; cursor: pointer; pointer-events: auto; background: rgba(0,0,0,0.5); z-index: 25; color: #fff; }
        #pause-btn-hud:active { background: #fff; color: #000; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="scanlines"></div>
    <div id="damage-flash"></div>

    <div id="hud-layer" class="ui-layer">
        <div id="score-display">SCORE: 0</div>
        <div id="pause-btn-hud" onclick="togglePause()">||</div>

        <div id="currency-display">
            <img src="assets/images/energy.png" class="currency-icon">
            <span id="hud-wallet-val">0</span>
        </div>
        <div id="flow-meter"><div id="flow-fill"></div></div>
        <div id="flow-label" class="hud-element" style="top:78px; left:20px; font-size:12px; color:#aaa; letter-spacing:2px;">FLOW CHAIN</div>
        <div id="multiplier-display">x1.0</div>
        <div id="beat-bar"></div>
        <div id="district-announcer">DISTRICT 1</div>
        <div id="ability-btn" style="display:none;" onclick="triggerShield()">SHIELD<br>READY<br>[SPACE]</div>
        <div id="turbo-btn">‚ö°</div> 
    </div>

    <div id="controls-layer">
        <div id="btn-left" class="control-btn">‚¨Ö</div>
        <div id="btn-right" class="control-btn">‚û°</div>
        <div id="btn-jump" class="control-btn">‚¨Ü</div>
        <div id="btn-slide" class="control-btn">‚¨á</div>
    </div>

    <div id="pause-layer" class="menu-overlay">
        <div class="card-panel">
            <h2 style="margin-top:0; color:#fff;">SYSTEM PAUSED</h2>
            <button onclick="togglePause()" style="margin-top:20px; width:100%;">RESUME</button>
            <button onclick="abortRun()" style="margin-top:10px; width:100%; background:#ff5500;">ABORT RUN</button>
        </div>
    </div>

    <div id="intro-layer" class="menu-overlay">
        <img src="assets/images/LogoSyncStudios.png" class="studio-logo">
        <div style="font-size:24px; letter-spacing:4px; font-weight:bold; margin-top:20px; color:#fff;">DREAM. DIVE. DISRUPT.</div>
        <div id="loading-area"><p id="loading-text" style="color:#00ffff; margin-top:30px; animation:blink 1s infinite;">LOADING ASSETS...</p></div>
        <button id="enter-btn" style="display:none; margin-top:40px; background:#fff; color:#000;" onclick="enterMainHub()">READY FOR CHALLENGE</button>
    </div>

    <div id="tutorial-layer" class="menu-overlay">
        <div class="card-panel">
            <h2 style="margin-top:0; color:#00ffff;">PILOT TRAINING</h2>
            <div class="tut-row"><div class="tut-icon">‚¨ÖÔ∏è‚û°Ô∏è</div> <div>SWIPE to Dodge Enemies</div></div>
            <div class="tut-row"><div class="tut-icon">‚¨ÜÔ∏è</div> <div>SWIPE UP to Jump <span style="color:#ff5500">Red Beams</span></div></div>
            <div class="tut-row"><div class="tut-icon">‚¨áÔ∏è</div> <div>SWIPE DOWN to Slide <span style="color:#cc00ff">Purple Beams</span></div></div>
            <div class="tut-row"><div class="tut-icon">‚ö°</div> <div>HOLD ‚ö° to Overdrive (2x Score)</div></div>
            <button onclick="closeTutorial()">I'M READY</button>
        </div>
    </div>
    
    <div id="leaderboard-layer" class="menu-overlay">
        <div class="card-panel">
            <h2 style="margin-top:0; color:#ffd700;">GLOBAL PILOTS</h2>
            <div id="lb-content">Loading...</div>
            <div id="submit-area" style="display:none; margin-top:20px; border-top:1px solid #333; padding-top:10px;">
                <p>NEW HIGH SCORE!</p>
                <input type="text" id="player-name-input" placeholder="ENTER PILOT ID" maxlength="10">
                <button onclick="Leaderboard.submit()" style="margin-top:10px; font-size:16px;">UPLOAD</button>
            </div>
            <button onclick="Leaderboard.close()" style="margin-top:20px; background:#333;">CLOSE</button>
        </div>
    </div>

    <div id="menu-layer" class="menu-overlay">
        <h1>VYRA: NEO-SEOUL</h1>
        <div id="shop-area" style="width: 100%; display:flex; flex-direction:column; align-items:center;">
            
            <div class="control-toggle">
                <div id="toggle-swipe" class="toggle-btn active" onclick="Economy.setControls('SWIPE')">SWIPE</div>
                <div id="toggle-buttons" class="toggle-btn" onclick="Economy.setControls('BUTTONS')">BUTTONS</div>
            </div>

            <div class="wallet-header">
                <div class="wallet-item">
                    <img src="assets/images/energy.png" class="currency-icon">
                    <span id="menu-energy" style="color:#00ffff">0</span>
                </div>
                <div class="wallet-item">
                    <img src="assets/images/aurum.png" class="currency-icon">
                    <span id="menu-aurum" style="color:#ffd700">0</span>
                </div>
            </div>
            
            <button onclick="Leaderboard.show()" style="font-size:14px; padding:10px 30px; background:#333; box-shadow:none; margin-bottom:20px;">üèÜ RANKINGS</button>

            <h3>BLACK MARKET (CONSUMABLES)</h3>
            <div class="shop-container">
                <div class="shop-item" id="btn-shield" onclick="Economy.buyShield()">
                    <div class="item-icon">üõ°Ô∏è</div>
                    <div class="item-name">ACTIVE SHIELD</div>
                    <div class="price-tag cost-energy" id="price-shield">300 ENERGY</div>
                    <div class="item-desc">Invincible Start</div>
                </div>
                <div class="shop-item premium" id="btn-revive" onclick="Economy.buyRevive()">
                    <div class="item-icon">üíñ</div>
                    <div class="item-name">NANOBOT HEART</div>
                    <div class="price-tag cost-aurum" id="price-revive">10 AURUM</div>
                    <div class="item-desc">Auto-Revive (1x)</div>
                </div>
                <div class="shop-item" id="btn-refine" onclick="Economy.refineEnergy()">
                    <div class="item-icon">‚ôªÔ∏è</div>
                    <div class="item-name">REFINERY</div>
                    <div class="price-tag cost-energy">1000 ENERGY</div>
                    <div class="item-desc">Get 1 Aurum</div>
                </div>
            </div>
            
            <h3>CYBERWARE (PERMANENT)</h3>
            <div class="shop-container">
                 <div class="shop-item premium" id="btn-magnet" onclick="Economy.buyMagnet()">
                    <div class="item-icon">üß≤</div>
                    <div class="item-name">DATA SIPHON</div>
                    <div class="price-tag cost-aurum" id="price-magnet">6 AURUM</div>
                    <div class="item-desc">Auto-Collect Orbs</div>
                </div>
                <div class="shop-item premium" id="btn-skin-shadow" onclick="Economy.handleSkinAction('shadow', 8)">
                    <div class="item-icon">ü•∑</div>
                    <div class="item-name">SHADOW OPS</div>
                    <div class="price-tag cost-aurum" id="price-skin-shadow">8 AURUM</div>
                    <div class="item-desc">Stealth Suit</div>
                </div>
                <div class="shop-item premium" id="btn-skin-gold" onclick="Economy.handleSkinAction('gold', 30)">
                    <div class="item-icon">üåü</div>
                    <div class="item-name">VALKYRIE</div>
                    <div class="price-tag cost-aurum" id="price-skin-gold">30 AURUM</div>
                    <div class="item-desc">Solid Gold</div>
                </div>
                 <div class="shop-item premium" id="btn-trail" onclick="Economy.buyTrail()">
                    <div class="item-icon">‚ú®</div>
                    <div class="item-name">NEON AURA</div>
                    <div class="price-tag cost-aurum" id="price-trail">5 AURUM</div>
                    <div class="item-desc">Cyber Aura FX</div>
                </div>
            </div>

            <h3>NEO-BANK (DATA PACKS)</h3>
            <div class="shop-container">
                <div class="shop-item real-money" onclick="Economy.buyPack(2, '$1.99')">
                    <img src="assets/images/aurum.png" style="width:30px; margin-bottom:5px;">
                    <div class="item-name">1 MB CACHE</div>
                    <div class="item-desc">2 Aurum</div>
                    <div class="price-tag cost-real">$1.99</div>
                </div>
                <div class="shop-item real-money" id="btn-pass" onclick="Economy.buyPass()">
                    <img src="assets/images/aurum.png" style="width:30px; margin-bottom:5px;">
                    <div class="item-name">10 MB PASS</div>
                    <div class="item-desc" id="pass-desc">5 + 2 Daily (30d)</div>
                    <div class="price-tag cost-real">$4.99</div>
                </div>
                <div class="shop-item real-money" onclick="Economy.buyPack(12, '$9.99')">
                    <img src="assets/images/aurum.png" style="width:40px; margin-bottom:5px;">
                    <div class="item-name">100 MB DATA</div>
                    <div class="item-desc">12 Aurum</div>
                    <div class="price-tag cost-real">$9.99</div>
                </div>
                <div class="shop-item real-money" onclick="Economy.buyPack(75, '$49.99')">
                    <img src="assets/images/aurum.png" style="width:50px; margin-bottom:5px;">
                    <div class="item-name">1 TB DUMP</div>
                    <div class="item-desc">75 Aurum</div>
                    <div class="price-tag cost-real">$49.99</div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="start-btn" style="margin-top:0;">INITIATE RUN</button>
            </div>
            <button id="reset-save-btn" style="font-size:10px; padding:5px; background:none; border:1px solid #444; color:#666; margin-top:30px; width:auto; box-shadow:none;">RESET DATA</button>
        </div>
    </div>
    
    <div id="gameover-layer" class="menu-overlay" style="display:none;">
        <h1 style="color:#ff0055; text-shadow: 0 0 20px #ff0055;">SYSTEM CRASH</h1>
        <p id="gameover-stats" style="text-align:center; color:#fff; font-size: 20px; line-height: 1.8;"></p>
        <button id="submit-score-btn" onclick="Leaderboard.openSubmit()" style="background:#ffd700; color:#000; margin-bottom:10px;">UPLOAD SCORE</button>
        <button id="return-btn" onclick="returnToMenu()">RETURN TO HUB</button>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (PLACEHOLDER) ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY_HERE",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID"
    };

    let db = null;
    try {
        if(typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        }
    } catch(e) { console.warn("Firebase Config Missing/Invalid"); }

    const Leaderboard = {
        lastScore: 0,
        fromGameOver: false,
        show() { 
            this.fromGameOver = false;
            document.getElementById('leaderboard-layer').style.display='flex'; 
            document.getElementById('submit-area').style.display='none'; 
            this.fetch(); 
        },
        openSubmit() { 
            this.fromGameOver = true;
            document.getElementById('gameover-layer').style.display='none'; 
            document.getElementById('leaderboard-layer').style.display='flex'; 
            document.getElementById('submit-area').style.display='block'; 
            if(Economy.data.pilotName) document.getElementById('player-name-input').value = Economy.data.pilotName; 
            this.fetch(); 
        },
        close() {
            document.getElementById('leaderboard-layer').style.display='none';
            if(this.fromGameOver) {
                document.getElementById('gameover-layer').style.display='flex';
                this.fromGameOver = false;
            }
        },
        async fetch() {
            if(!db) { document.getElementById('lb-content').innerHTML = "OFFLINE MODE"; return; }
            try {
                const q = db.collection("scores").orderBy("score", "desc").limit(10);
                const querySnapshot = await q.get();
                let html = `<table id="lb-table"><tr><th>RANK</th><th>PILOT</th><th>SCORE</th></tr>`;
                let rank = 1;
                querySnapshot.forEach((doc) => { html += `<tr><td>#${rank}</td><td>${doc.data().name}</td><td>${doc.data().score}</td></tr>`; rank++; });
                html += `</table>`;
                document.getElementById('lb-content').innerHTML = html;
            } catch(e) { document.getElementById('lb-content').innerHTML = "Error loading scores."; }
        },
        async submit() {
            if(!db) return;
            const name = document.getElementById('player-name-input').value.toUpperCase().substring(0, 10) || "UNKNOWN";
            Economy.data.pilotName = name; Economy.save();
            try { await db.collection("scores").add({ name: name, score: this.lastScore, date: firebase.firestore.FieldValue.serverTimestamp() }); alert("Score Uploaded!"); document.getElementById('submit-area').style.display='none'; this.fetch(); } catch(e) { alert("Upload failed."); }
        }
    };

    // --- 1. STATE ---
    const State = {
        isPlaying: false, isPaused: false, score: 0, distance: 0, flowMultiplier: 1.0, flowCharge: 0,
        isFlowState: false, gameSpeed: 5.0, runEnergy: 0, runAurum: 0,
        isTurbo: false, baseSpeed: 5.0,
        LANE_WIDTH_BASE: 90, PLAYER_Z_DEPTH: 100,
        player: { lane: 1, state: 'RUN', y: 0, dy: 0, jumpCount: 0, invulnerable: false },
        activeBoosts: { shield: false }, shieldAvailable: false,
        obstacles: [], particles: [], texts: [], beatScale: 1.0,
        currentDistrict: 0, lastSpawnHeavy: false,
        lastEnergyLane: -1, energyLaneStreak: 0, consecutiveEmptyBeats: 0,
        districts: [
            { name: "NEO-CORE", color: "#c000ff", sky: "rgba(0,0,50,0.4)" }, 
            { name: "SECTOR-9", color: "#ffaa00", sky: "rgba(50,20,0,0.4)" }, 
            { name: "THE VOID", color: "#ffffff", sky: "rgba(20,20,20,0.6)" }  
        ]
    };

    // --- 2. ECONOMY ---
    const Economy = {
        data: { aurum: 10, energy: 0, unlockedTrail: false, unlockedMagnet: false, unlockedSkins: [], equippedSkin: 'default', hasRevive: false, tutorialSeen: false, pilotName: "", controlMode: 'SWIPE',
            passActive: false, passDays: 0, lastPassClaim: 0 },
        init() {
            try { const saved = localStorage.getItem('vyraData'); if(saved) this.data = JSON.parse(saved); } catch (e) { this.resetSave(); }
            if(typeof this.data.energy === 'undefined') this.data.energy = 0;
            if(typeof this.data.passActive === 'undefined') { this.data.passActive = false; this.data.passDays = 0; this.data.lastPassClaim = 0; }
            this.checkDailyPass();
            this.updateUI();
        },
        save() { localStorage.setItem('vyraData', JSON.stringify(this.data)); this.updateUI(); },
        resetSave() { if(confirm("‚ö† WARNING: Reset ALL data?")) { this.data = { aurum: 10, energy: 0, unlockedTrail: false, unlockedMagnet: false, unlockedSkins: [], equippedSkin: 'default', hasRevive: false, tutorialSeen: false, pilotName: "", controlMode: 'SWIPE', passActive: false, passDays: 0, lastPassClaim: 0 }; this.save(); alert("Data Reset."); } },
        setControls(mode) { this.data.controlMode = mode; this.save(); },
        
        checkDailyPass() {
            if(this.data.passActive && this.data.passDays > 0) {
                let now = Date.now();
                if(now - this.data.lastPassClaim > 86400000) { // 24 hours
                    this.data.aurum += 2;
                    this.data.passDays--;
                    this.data.lastPassClaim = now;
                    if(this.data.passDays <= 0) this.data.passActive = false;
                    this.save();
                    alert("DAILY SUPPLY DROP: +2 AURUM RECEIVED!");
                }
            }
        },

        updateUI() {
            document.getElementById('menu-aurum').innerText = this.data.aurum;
            document.getElementById('menu-energy').innerText = this.data.energy;
            document.getElementById('hud-wallet-val').innerText = State.runEnergy; 

            this.updateButton('price-shield', 300, false, "EQUIPPED", State.activeBoosts.shield, 'energy');
            this.updateButton('price-revive', 10, false, "OWNED", this.data.hasRevive, 'aurum');
            this.updateButton('price-magnet', 6, this.data.unlockedMagnet, "INSTALLED", false, 'aurum');
            this.updateButton('price-trail', 5, this.data.unlockedTrail, "OWNED", false, 'aurum');
            
            // Skin Logic
            this.updateSkinButton('price-skin-shadow', 8, 'shadow');
            this.updateSkinButton('price-skin-gold', 30, 'gold');
            
            // Pass UI
            const passBtn = document.getElementById('btn-pass');
            const passDesc = document.getElementById('pass-desc');
            if(this.data.passActive) {
                passBtn.style.borderColor = '#00ff00';
                passDesc.innerText = `ACTIVE: ${this.data.passDays} DAYS LEFT`;
                passDesc.style.color = '#00ff00';
            } else {
                passBtn.style.borderColor = '';
                passDesc.innerText = "5 + 2 Daily (30d)";
                passDesc.style.color = '#aaa';
            }

            document.getElementById('toggle-swipe').className = this.data.controlMode === 'SWIPE' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('toggle-buttons').className = this.data.controlMode === 'BUTTONS' ? 'toggle-btn active' : 'toggle-btn';
        },
        updateButton(id, cost, isOwned, ownedText, isEquipped, type) {
            const el = document.getElementById(id); if(!el) return;
            if (isEquipped) { el.innerText = "EQUIPPED"; el.style.color = "#00ff00"; return; }
            if (isOwned) { el.innerText = ownedText; el.style.color = "#00ff00"; } 
            else { 
                let currency = type === 'energy' ? this.data.energy : this.data.aurum;
                el.innerText = `${cost} ${type.toUpperCase()}`; 
                el.style.color = currency >= cost ? (type==='energy' ? "#00ffff" : "#ffd700") : "#555"; 
            }
        },
        updateSkinButton(id, cost, skinName) {
            const el = document.getElementById(id); if(!el) return;
            const owned = this.data.unlockedSkins.includes(skinName);
            if (this.data.equippedSkin === skinName) { el.innerText = "EQUIPPED"; el.style.color = "#00ff00"; }
            else if (owned) { el.innerText = "EQUIP"; el.style.color = "#fff"; } // No onclick here anymore, handled by handleSkinAction
            else { el.innerText = `${cost} AURUM`; el.style.color = this.data.aurum >= cost ? "#ffd700" : "#555"; }
        },
        // ACTIONS
        buyShield() { if (!State.activeBoosts.shield && this.data.energy >= 300) { this.data.energy -= 300; State.activeBoosts.shield = true; this.save(); }},
        buyRevive() { if (!this.data.hasRevive && this.data.aurum >= 10) { this.data.aurum -= 10; this.data.hasRevive = true; this.save(); }},
        buyMagnet() { if (!this.data.unlockedMagnet && this.data.aurum >= 6) { this.data.aurum -= 6; this.data.unlockedMagnet = true; this.save(); }},
        buyTrail() { if (!this.data.unlockedTrail && this.data.aurum >= 5) { this.data.aurum -= 5; this.data.unlockedTrail = true; this.save(); }},
        
        handleSkinAction(skinName, cost) {
            if (this.data.unlockedSkins.includes(skinName)) {
                this.equipSkin(skinName);
                alert("SKIN EQUIPPED");
            } else {
                if (this.data.aurum >= cost) {
                    this.data.aurum -= cost;
                    this.data.unlockedSkins.push(skinName);
                    this.equipSkin(skinName);
                    alert("PURCHASE SUCCESSFUL: SKIN EQUIPPED");
                } else {
                    alert("INSUFFICIENT FUNDS");
                }
            }
        },
        equipSkin(skinName) { 
            this.data.equippedSkin = skinName; 
            this.save();
            this.updateUI(); // Explicit update
        },
        
        refineEnergy() { if(this.data.energy >= 1000) { this.data.energy -= 1000; this.data.aurum += 1; this.save(); alert("Refined 1000 Energy into 1 Aurum!"); }},
        buyPack(amount, priceStr) { if(confirm(`Purchase ${amount} Aurum for ${priceStr}?`)) { setTimeout(() => { this.data.aurum += amount; this.save(); alert("Payment Successful!"); }, 500); }},
        
        buyPass() {
            if(this.data.passActive) { alert("Pass already active!"); return; }
            if(confirm("Purchase 10 MB PASS for $4.99?")) {
                setTimeout(() => {
                    this.data.aurum += 5;
                    this.data.passActive = true;
                    this.data.passDays = 30;
                    this.data.lastPassClaim = Date.now();
                    this.save();
                    alert("PASS ACTIVATED: +5 AURUM INITIAL DROP");
                }, 500);
            }
        }
    };

    // --- 3. ASSETS & AUDIO ---
    const Assets = { images: {}, loadedCount: 0, total: 8 }; 
    const AudioSys = {
        ctx: null, masterGain: null, isPlaying: false, sequencerTimer: null, noteIndex: 0,
        bassLine: [65.41, 65.41, 77.78, 65.41, 51.91, 51.91, 58.27, 58.27], 
        init() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            this.masterGain = this.ctx.createGain();
            this.masterGain.gain.value = 0.4; 
            this.masterGain.connect(this.ctx.destination);
        },
        resume() { if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume(); },
        playTone(freq, type, duration, vol=1) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.masterGain);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        playJump() { if(!this.ctx)return; this.playTone(200, 'triangle', 0.2, 0.4); },
        playCollect() { if(!this.ctx)return; this.playTone(880, 'sine', 0.1, 0.5); setTimeout(()=>this.playTone(1760,'sine',0.1,0.3),50); },
        playCrash() { if(!this.ctx)return; this.playTone(100, 'sawtooth', 0.3, 0.8); this.playTone(50, 'square', 0.4, 0.8); },
        startMusic() {
            this.resume(); this.isPlaying = true; this.noteIndex = 0;
            if(this.sequencerTimer) clearTimeout(this.sequencerTimer);
            const playStep = () => {
                if(!State.isPlaying || State.isPaused) { if(!State.isPaused) this.isPlaying = false; return; }
                const freq = this.bassLine[this.noteIndex % this.bassLine.length];
                let pitchMod = State.isTurbo ? 1.5 : 1.0;
                this.playTone(freq * pitchMod, 'sawtooth', 0.15, 0.4);
                if (this.noteIndex % 2 === 0) { let arp = freq*4*pitchMod; this.playTone(arp, 'triangle', 0.1, 0.15); } 
                if (this.noteIndex % 2 === 0) this.playTone(10000, 'square', 0.05, 0.05); 
                if (this.noteIndex % 4 === 0) this.playTone(100, 'sine', 0.1, 1); 
                this.noteIndex++;
                let speedAdj = Math.max(80, 250 - (State.gameSpeed * 10));
                this.sequencerTimer = setTimeout(playStep, speedAdj);
            };
            playStep();
        },
        stopMusic() { this.isPlaying = false; clearTimeout(this.sequencerTimer); }
    };

    function loadGameAssets(onComplete) {
        let completed = false;
        setTimeout(() => { if(!completed) { completed=true; onComplete(); } }, 2000); 
        const check = () => { Assets.loadedCount++; if (!completed && Assets.loadedCount >= Assets.total) { completed = true; onComplete(); } };
        const loadImg = (key, src) => { Assets.images[key] = new Image(); Assets.images[key].src = src; Assets.images[key].onload = check; Assets.images[key].onerror = check; };
        loadImg('player', 'assets/images/player.png'); loadImg('bg', 'assets/images/bg.png'); 
        loadImg('energy', 'assets/images/energy.png'); // Soft
        loadImg('enemy1', 'assets/images/enemy1.jpg'); loadImg('enemy2', 'assets/images/enemy2.jpg'); loadImg('enemy3', 'assets/images/enemy3.jpg'); loadImg('enemy4', 'assets/images/enemy4.jpg');
        loadImg('logo', 'assets/images/LogoSyncStudios.png');
    }

    // --- 4. ENGINE ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let lastTime = 0, beatTimer = 0;
    const BPM = 120, BEAT_INTERVAL = 60 / BPM * 1000;
    const GRAVITY = 0.8; const JUMP_FORCE = 16; 

    function initGame() {
        resize(); window.addEventListener('resize', resize);
        Economy.init(); initInput();

        document.getElementById('start-btn').addEventListener('click', checkTutorial);
        
        const turboBtn = document.getElementById('turbo-btn');
        const startTurbo = (e) => { e.preventDefault(); if(State.isPlaying && !State.isPaused) { State.isTurbo = true; turboBtn.classList.add('active'); }};
        const endTurbo = (e) => { e.preventDefault(); State.isTurbo = false; turboBtn.classList.remove('active'); };
        turboBtn.addEventListener('mousedown', startTurbo); turboBtn.addEventListener('mouseup', endTurbo); turboBtn.addEventListener('mouseleave', endTurbo);
        turboBtn.addEventListener('touchstart', startTurbo); turboBtn.addEventListener('touchend', endTurbo);
        
        document.getElementById('btn-left').addEventListener('touchstart', (e) => { e.preventDefault(); changeLane(-1); });
        document.getElementById('btn-right').addEventListener('touchstart', (e) => { e.preventDefault(); changeLane(1); });
        document.getElementById('btn-jump').addEventListener('touchstart', (e) => { e.preventDefault(); doJump(); });
        document.getElementById('btn-slide').addEventListener('touchstart', (e) => { e.preventDefault(); doSlide(); });

        loadGameAssets(() => { document.getElementById('loading-area').style.display='none'; document.getElementById('enter-btn').style.display='block'; Economy.updateUI(); });
    }

    function enterMainHub() { document.getElementById('intro-layer').style.display = 'none'; document.getElementById('menu-layer').style.display = 'flex'; }
    function checkTutorial() { if (!Economy.data.tutorialSeen) { document.getElementById('menu-layer').style.display='none'; document.getElementById('tutorial-layer').style.display='flex'; } else { startGame(); } }
    window.closeTutorial = function() { Economy.data.tutorialSeen = true; Economy.save(); document.getElementById('tutorial-layer').style.display='none'; startGame(); }
    
    // Global Return
    window.returnToMenu = function() {
        document.getElementById('gameover-layer').style.display = 'none';
        document.getElementById('pause-layer').style.display = 'none';
        document.getElementById('menu-layer').style.display = 'flex';
        document.getElementById('hud-layer').classList.remove('visible');
        document.getElementById('controls-layer').style.display='none';
        State.isPlaying = false; State.isPaused = false;
        AudioSys.stopMusic();
        Economy.updateUI();
    };

    window.togglePause = function() {
        if(!State.isPlaying) return;
        State.isPaused = !State.isPaused;
        if(State.isPaused) {
            AudioSys.ctx.suspend();
            document.getElementById('pause-layer').style.display = 'flex';
            document.getElementById('controls-layer').style.display = 'none';
        } else {
            AudioSys.ctx.resume();
            document.getElementById('pause-layer').style.display = 'none';
            if(Economy.data.controlMode === 'BUTTONS') document.getElementById('controls-layer').style.display = 'block';
            lastTime = performance.now();
            AudioSys.startMusic(); 
            requestAnimationFrame(loop);
        }
    }
    
    window.abortRun = function() {
        togglePause(); 
        State.isPaused = false;
        gameOver();
    }

    function startGame() {
        document.getElementById('start-btn').blur(); document.getElementById('menu-layer').style.display='none'; document.getElementById('gameover-layer').style.display='none'; document.getElementById('hud-layer').classList.add('visible');
        if(Economy.data.controlMode === 'BUTTONS') { document.getElementById('controls-layer').style.display='block'; document.getElementById('ability-btn').style.bottom='140px'; document.getElementById('turbo-btn').style.bottom='200px'; } 
        else { document.getElementById('controls-layer').style.display='none'; document.getElementById('ability-btn').style.bottom='40px'; document.getElementById('turbo-btn').style.bottom='140px'; }
        State.isPlaying = true; State.isPaused = false;
        AudioSys.init(); AudioSys.startMusic(); resetGame(); lastTime = performance.now(); requestAnimationFrame(loop);
    }

    function resetGame() {
        State.score = 0; State.distance = 0; State.flowMultiplier = 1.0; State.flowCharge = 0; State.runEnergy = 0; State.runAurum = 0; State.isFlowState = false; State.texts = []; State.currentDistrict = 0; State.lastSpawnHeavy = false; beatTimer = 0; 
        State.player.y = 0; State.player.dy = 0; State.player.state = 'RUN'; State.player.jumpCount = 0;
        State.isTurbo = false; State.gameSpeed = 5.0; State.baseSpeed = 5.0;
        if (State.activeBoosts.shield) { State.shieldAvailable = true; document.getElementById('ability-btn').style.display='flex'; } else { State.shieldAvailable = false; document.getElementById('ability-btn').style.display='none'; }
        State.player.invulnerable = false; document.getElementById('hud-layer').classList.remove('flow-active');
        State.obstacles = []; State.particles = []; State.player.lane = 1; updateHUD(); announceDistrict(0);
        State.energyLaneStreak = 0; State.lastEnergyLane = -1; State.consecutiveEmptyBeats = 0;
    }

    window.triggerShield = function() {
        if (State.isPlaying && !State.isPaused && State.shieldAvailable && !State.isFlowState) { activateFlowState(); spawnFloatingText("SHIELD DEPLOYED!", "#00ff00"); AudioSys.playCollect(); State.shieldAvailable = false; State.activeBoosts.shield = false; document.getElementById('ability-btn').style.display='none'; }
    };

    function announceDistrict(idx) { let d = State.districts[idx]; let el = document.getElementById('district-announcer'); el.innerText = "ENTERING: " + d.name; el.style.color = d.color; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 3000); }

    function loop(timestamp) {
        if (!State.isPlaying || State.isPaused) return;
        try {
            let dt = timestamp - lastTime; lastTime = timestamp; updatePhysics();
            beatTimer += dt; if (beatTimer > BEAT_INTERVAL) { beatTimer = 0; triggerBeat(); }
            if (State.beatScale > 1.0) State.beatScale -= 0.05;
            render(); requestAnimationFrame(loop);
        } catch (e) { console.error(e); State.isPlaying = false; }
    }

    // --- UNIFIED PERSPECTIVE HELPER ---
    function getLaneCenterX(lane, scale) {
        let cx = canvas.width / 2;
        let laneOffset = (lane - 1); // -1, 0, 1
        return cx + (laneOffset * State.LANE_WIDTH_BASE * 2 * scale);
    }

    function updatePhysics() {
        let speedMod = State.isTurbo ? 1.5 : 1.0; let effectiveSpeed = State.gameSpeed * speedMod;
        State.distance += effectiveSpeed * 0.1;
        let mult = State.flowMultiplier * (State.isFlowState ? 2 : 1) * (State.isTurbo ? 2 : 1);
        State.score += (effectiveSpeed * 0.1) * mult;
        let nextDistIdx = Math.floor(State.distance / 1000);
        if (nextDistIdx > State.currentDistrict && nextDistIdx < State.districts.length) { State.currentDistrict = nextDistIdx; announceDistrict(State.currentDistrict); spawnFloatingText("SPEED UP!", "#fff"); State.baseSpeed += 1; }
        State.gameSpeed = State.baseSpeed;
        if (State.isFlowState) { State.flowCharge -= 0.3; if (State.flowCharge <= 0) deactivateFlowState(); }
        if (State.player.state === 'JUMP') { State.player.y += State.player.dy; State.player.dy -= GRAVITY; if (State.player.y <= 0) { State.player.y = 0; State.player.dy = 0; State.player.state = 'RUN'; State.player.jumpCount = 0; } } else if (State.player.state === 'SLIDE') { State.player.animTimer--; if (State.player.animTimer <= 0) State.player.state = 'RUN'; }
        
        // MAGNET LOGIC
        if (Economy.data.unlockedMagnet) {
            for (let obs of State.obstacles) {
                if (obs.type === 'ENERGY' && !obs.hit && obs.z < State.PLAYER_Z_DEPTH + 400 && obs.z > State.PLAYER_Z_DEPTH - 100) {
                    // Pull towards player lane visually
                    if (obs.lane < State.player.lane) obs.lane += 0.1;
                    if (obs.lane > State.player.lane) obs.lane -= 0.1;
                    // Auto Collect if close
                    if (Math.abs(obs.lane - State.player.lane) < 0.5) {
                        obs.hit = true; obs.visible = false; collectEnergy();
                    }
                }
            }
        }

        for (let i = State.obstacles.length - 1; i >= 0; i--) {
            let obs = State.obstacles[i]; obs.z -= effectiveSpeed;
            let zNear = State.PLAYER_Z_DEPTH - 30; let zFar = State.PLAYER_Z_DEPTH + 30;
            if (obs.z < zFar && obs.z > zNear && !obs.hit) { if (Math.round(obs.lane) === State.player.lane) checkCollision(obs); }
            if (obs.z < -200) State.obstacles.splice(i, 1);
        }
        State.particles.forEach((p, i) => { p.life--; p.x += p.vx; p.y += p.vy; if (p.life<=0) State.particles.splice(i,1); });
        State.texts.forEach((t, i) => { t.y -= 1; t.life--; if (t.life<=0) State.texts.splice(i,1); });
        updateHUD();
    }

    function checkCollision(obs) {
        if (obs.type === 'ENERGY') { obs.hit = true; obs.visible = false; collectEnergy(); return; }
        if (State.isFlowState) { obs.hit = true; obs.visible = false; spawnParticles(0, 0, 10, '#ffd700'); spawnFloatingText("SMASH!", "#ffd700"); AudioSys.playCrash(); State.score += 500; return; }
        if (obs.type === 'LOW_BEAM') { if (State.player.y > 60) return; }
        else if (obs.type === 'ENEMY') { } // Crash
        else if (obs.type === 'HIGH_BEAM') { if (State.player.state === 'SLIDE') { spawnFloatingText("SLIDE!", "#00ff00"); return; } }
        
        // REVIVE CHECK
        if (Economy.data.hasRevive) {
            Economy.data.hasRevive = false; Economy.save();
            activateFlowState(); // Invulnerable
            spawnFloatingText("REVIVED!", "#ff00ff");
            obs.hit = true; obs.visible = false; // Destroy collision object
            return;
        }

        shakeScreen(); spawnFloatingText("CRASH!", "#ff0000"); AudioSys.playCrash();
        const flash = document.getElementById('damage-flash'); flash.style.opacity = 0.5; setTimeout(() => flash.style.opacity = 0, 100);
        gameOver(); 
    }

    function collectEnergy() {
        State.runEnergy += 1; AudioSys.playCollect();
        if (State.isFlowState) { State.flowCharge = Math.min(100, State.flowCharge + 5); State.score += 200; }
        else { State.flowCharge += 15; spawnFloatingText("PULSE +", "#00ffff"); spawnParticles(0, 0, 5, '#00ffff'); State.score += 100; if (State.flowCharge >= 100) activateFlowState(); }
        State.flowMultiplier = Math.min(10.0, State.flowMultiplier + 0.1);
    }

    function activateFlowState() { State.isFlowState = true; State.flowCharge = 100; State.player.invulnerable = true; State.baseSpeed += 5; document.getElementById('hud-layer').classList.add('flow-active'); spawnFloatingText("FLOW STATE", "#ffd700"); }
    function deactivateFlowState() { State.isFlowState = false; State.flowCharge = 0; State.player.invulnerable = false; State.baseSpeed = Math.max(6, State.baseSpeed - 5); document.getElementById('hud-layer').classList.remove('flow-active'); spawnFloatingText("FLOW ENDED", "#cccccc"); }

    function gameOver() {
        State.isPlaying = false; AudioSys.stopMusic(); Leaderboard.lastScore = Math.floor(State.score);
        Economy.data.energy += State.runEnergy; Economy.save();
        document.getElementById('hud-layer').classList.remove('visible'); 
        // Force hide controls
        document.getElementById('controls-layer').style.display='none';
        document.getElementById('pause-layer').style.display='none';
        document.getElementById('gameover-layer').style.display = 'flex';
        document.getElementById('gameover-stats').innerHTML = `SCORE: ${Math.floor(State.score)}<br>DISTANCE: ${Math.floor(State.distance)}m<br><span style="color:#00ffff">COLLECTED: ${State.runEnergy} </span> <img src="assets/images/energy.png" style="width:20px;vertical-align:middle;">`;
    }

    function returnToMenu() { document.getElementById('gameover-layer').style.display = 'none'; document.getElementById('menu-layer').style.display = 'flex'; Economy.updateUI(); }

    function triggerBeat() {
        const beatBar = document.getElementById('beat-bar'); if(beatBar) { beatBar.classList.add('beat-hit'); setTimeout(() => beatBar.classList.remove('beat-hit'), 100); }
        State.beatScale = 2.0; 
        let spawnRates = [0.4, 0.5, 0.6]; let currentRate = spawnRates[Math.min(State.currentDistrict, 2)];
        if (Math.random() > currentRate) return; 
        let maxCount = 2; if (State.lastSpawnHeavy) { maxCount = 1; State.lastSpawnHeavy = false; } else { if (Math.random() < 0.4) { maxCount = 2; State.lastSpawnHeavy = true; } else { maxCount = 1; } }
        let lanes = [0, 1, 2].sort(() => Math.random() - 0.5); let count = Math.min(maxCount, (Math.random() < 0.5 ? 1 : 2)); 
        
        let patternRoll = Math.random();
        if (patternRoll < 0.2) { 
            let chosenLane = lanes[0];
            if(chosenLane === State.lastEnergyLane) { State.energyLaneStreak++; if(State.energyLaneStreak >= 3) chosenLane = (chosenLane + 1) % 3; } else { State.energyLaneStreak = 1; }
            State.lastEnergyLane = chosenLane;
            State.obstacles.push({ lane: chosenLane, type: 'ENERGY', subType: 1, z: 1600, hit: false, visible: true }); 
            State.obstacles.push({ lane: chosenLane, type: 'ENEMY', subType: 1, z: 2000, hit: false, visible: true }); 
        } 
        else { 
            for (let i = 0; i < count; i++) { 
                let r = Math.random(); let type = 'ENEMY'; let subType = 1; 
                let chosenLane = lanes[i];
                if (r < 0.3) { 
                    type = 'ENERGY';
                    if(chosenLane === State.lastEnergyLane) { State.energyLaneStreak++; if(State.energyLaneStreak >= 3) chosenLane = (chosenLane + 1) % 3; } else { State.energyLaneStreak = 1; }
                    State.lastEnergyLane = chosenLane;
                } else if (r < 0.5) { type = 'LOW_BEAM'; } else if (r < 0.7) { type = 'HIGH_BEAM'; } else { type = 'ENEMY'; subType = Math.floor(Math.random()*4)+1; } 
                State.obstacles.push({ lane: chosenLane, type: type, subType: subType, z: 2000, hit: false, visible: true }); 
            } 
        }
        if (!State.isFlowState && State.baseSpeed < 12.0) State.baseSpeed += 0.002;
    }

    // --- 5. RENDERER ---
    function initInput() {
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Escape') { togglePause(); return; }
            if (!State.isPlaying || State.isPaused) return;
            if (e.code === 'Space') { triggerShield(); return; }
            if (e.key === 'Shift') { State.isTurbo = true; document.getElementById('turbo-btn').classList.add('active'); return; }
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) { e.preventDefault(); }
            switch(e.key) { case 'ArrowLeft': case 'a': case 'A': changeLane(-1); break; case 'ArrowRight': case 'd': case 'D': changeLane(1); break; case 'ArrowUp': case 'w': case 'W': doJump(); break; case 'ArrowDown': case 's': case 'S': doSlide(); break; }
        });
        document.addEventListener('keyup', (e) => { if(e.key === 'Shift') { State.isTurbo = false; document.getElementById('turbo-btn').classList.remove('active'); }});
        
        let tsX=0, tsY=0;
        document.addEventListener('touchstart', e => { tsX = e.changedTouches[0].screenX; tsY = e.changedTouches[0].screenY; }, {passive:false});
        document.addEventListener('touchend', e => {
            if (!State.isPlaying || State.isPaused || e.target.classList.contains('control-btn') || e.target.id === 'turbo-btn' || e.target.id === 'pause-btn-hud') return;
            let teX = e.changedTouches[0].screenX; let teY = e.changedTouches[0].screenY;
            let dx = teX - tsX; let dy = teY - tsY;
            if (Math.abs(dx) > Math.abs(dy)) { if (Math.abs(dx) > 30) changeLane(dx > 0 ? 1 : -1); } else { if (Math.abs(dy) > 30) { if (dy > 0) doSlide(); else doJump(); } }
        }, {passive:false});
    }

    function changeLane(dir) { let target = State.player.lane + dir; if (target >= 0 && target <= 2) { State.player.lane = target; let color = Economy.data.unlockedTrail ? '#00ffff' : '#ff00ff'; spawnParticles(0, 0, 5, color); } }
    function doJump() { if(State.player.state === 'RUN') { State.player.state = 'JUMP'; State.player.dy = JUMP_FORCE; State.player.jumpCount = 1; AudioSys.playJump(); } else if (State.player.state === 'JUMP' && State.player.jumpCount < 2) { State.player.dy = JUMP_FORCE * 0.8; State.player.jumpCount = 2; spawnParticles(0, 0, 10, '#00ffff'); AudioSys.playJump(); } }
    function doSlide() { if(State.player.state==='RUN') { State.player.state='SLIDE'; State.player.animTimer=35; } }

    function resize() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let cy = canvas.height / 2; let horizonY = cy - 50;
        let playerScreenY = canvas.height - 130;
        let maxDepthHeight = canvas.height - horizonY;
        let targetScale = (playerScreenY - horizonY) / maxDepthHeight;
        State.PLAYER_Z_DEPTH = (500 / targetScale) - 500;
        if (canvas.width < 600) { State.LANE_WIDTH_BASE = canvas.width / 5.0; } else { State.LANE_WIDTH_BASE = 120; }
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let offX = State.isFlowState ? (Math.random()-0.5)*10 : State.isTurbo ? (Math.random()-0.5)*5 : 0;
        let districtInfo = State.districts[State.currentDistrict] || State.districts[0];
        let dColor = districtInfo.color;
        
        if (Assets.images.bg && Assets.images.bg.complete) { ctx.save(); ctx.globalAlpha = 0.4; ctx.drawImage(Assets.images.bg, offX, 0, canvas.width, canvas.height); ctx.globalCompositeOperation = 'overlay'; ctx.fillStyle = districtInfo.sky; ctx.fillRect(0,0,canvas.width, canvas.height); ctx.restore(); } else { ctx.fillStyle = '#0a0a20'; ctx.fillRect(0,0, canvas.width, canvas.height); }
        
        let cx = canvas.width / 2; let cy = canvas.height / 2; let horizonY = cy - 50;
        ctx.strokeStyle = State.isFlowState ? '#ffd700' : dColor; 
        ctx.lineWidth = (2 * State.beatScale) + (State.isTurbo ? 2 : 0); 
        ctx.shadowBlur = State.isFlowState ? 30 : 15; ctx.shadowColor = ctx.strokeStyle;
        for (let i = -1.5; i <= 1.5; i += 1.0) { 
             let x1 = cx + (i * State.LANE_WIDTH_BASE * 2);
             let y1 = canvas.height; 
             let x2 = cx + (i * 10); 
             let y2 = horizonY; 
             ctx.beginPath(); ctx.moveTo(x1+offX, y1); ctx.lineTo(x2+offX, y2); ctx.stroke(); 
        }
        let offset = (State.distance % 100) / 100; for (let i = 0; i < 10; i++) { let p = (i + offset) / 10; let y = horizonY + (canvas.height - horizonY) * (p * p * p); ctx.globalAlpha = p; ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }
        ctx.globalAlpha = 1.0; ctx.shadowBlur = 0;

        let sortedObs = [...State.obstacles].sort((a, b) => b.z - a.z);
        sortedObs.forEach(obs => {
            if (!obs.visible) return;
            let scale = 500 / (obs.z + 500); if (scale < 0) scale = 0;
            
            // UNIFIED X CALCULATION
            let screenX = getLaneCenterX(obs.lane, scale) + offX;
            let groundY = horizonY + ((canvas.height - horizonY) * scale);
            let size = 100 * scale;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)'; ctx.beginPath(); ctx.ellipse(screenX, groundY, size * 0.8, size * 0.3, 0, 0, Math.PI * 2); ctx.fill();
            if (obs.type === 'ENEMY') { ctx.strokeStyle = '#ff0000'; ctx.lineWidth = 2; let ringSize = size * (1.5 - (obs.z / 1000)); if (ringSize > 0) { ctx.beginPath(); ctx.arc(screenX, groundY, ringSize, 0, Math.PI*2); ctx.stroke(); } }
            let drawY = groundY - size;
            
            if (obs.type === 'ENERGY') { 
                let spin = Math.sin(Date.now() / 200); let w = size * Math.abs(spin); let h = size; 
                if (Assets.images.energy && Assets.images.energy.complete) { ctx.save(); ctx.shadowColor = '#00ffff'; ctx.shadowBlur = 20; ctx.drawImage(Assets.images.energy, screenX - w/2, groundY - h - 10, w, h); ctx.restore(); } else { ctx.fillStyle = '#00ffff'; ctx.beginPath(); ctx.arc(screenX, groundY - size/2, size/3, 0, Math.PI*2); ctx.fill(); } 
            } 
            else if (obs.type === 'LOW_BEAM') { let barrierW = size * 1.8; ctx.fillStyle = '#ff3300'; ctx.shadowColor='#ff3300'; ctx.shadowBlur=30; ctx.fillRect(screenX - barrierW/2, groundY - size/2, barrierW, size/2); ctx.fillStyle = '#ffaa00'; ctx.fillRect(screenX - barrierW/2 + 5, groundY - size/2 + 5, 5, size/2-10); ctx.fillRect(screenX + barrierW/2 - 10, groundY - size/2 + 5, 5, size/2-10); }
            else if (obs.type === 'HIGH_BEAM') { 
                let beamY = groundY - size * 2.2; let barrierW = size * 2.0; ctx.fillStyle = '#cc00ff'; ctx.shadowColor='#cc00ff'; ctx.shadowBlur=30; ctx.fillRect(screenX - barrierW/2, beamY, barrierW, size/2); ctx.fillStyle = '#fff'; ctx.fillRect(screenX - barrierW/2, beamY + size/4 - 2, barrierW, 4); 
                // GRADIENT (TRANSPARENT)
                let grad = ctx.createLinearGradient(0, beamY, 0, beamY + size);
                grad.addColorStop(0, 'rgba(200,0,255,0.4)'); grad.addColorStop(1, 'rgba(200,0,255,0.1)');
                ctx.save(); ctx.globalCompositeOperation = 'screen'; ctx.fillStyle = grad; ctx.fillRect(screenX - barrierW/2, beamY, barrierW, size/2); ctx.restore();
            }
            else { 
                let enemyImg = Assets.images['enemy' + obs.subType]; 
                if (enemyImg && enemyImg.complete) { ctx.save(); ctx.shadowColor = '#ff0000'; ctx.shadowBlur = 10; ctx.drawImage(enemyImg, screenX - size/2, drawY, size, size); ctx.restore(); } else { ctx.fillStyle = '#ff0000'; ctx.fillRect(screenX - size/2, drawY, size, size); } 
                
                // GRADIENT WARNING (TRANSPARENT)
                let grad = ctx.createLinearGradient(0, drawY - size*3, 0, drawY);
                grad.addColorStop(0, 'rgba(255,0,0,0)'); grad.addColorStop(1, 'rgba(255,0,0,0.15)'); 
                ctx.save(); ctx.globalCompositeOperation = 'screen'; 
                ctx.fillStyle = grad; ctx.fillRect(screenX - size/2, drawY - size*3, size, size*3);
                ctx.restore();
            }
        });

        // PLAYER RENDER
        let scale = 500 / (State.PLAYER_Z_DEPTH + 500);
        let px = getLaneCenterX(State.player.lane, scale) + offX;
        let basePy = canvas.height - 150;
        let py = basePy - State.player.y; let size = 90; let squash = 1.0;
        if (State.player.state === 'SLIDE') { squash = 0.5; py += 50; }
        ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.beginPath(); ctx.ellipse(px, basePy + 20, 60, 20, 0, 0, Math.PI*2); ctx.fill(); 
        
        if (State.isFlowState) { ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(px, py - 40, 80, 0, Math.PI*2); ctx.stroke(); }
        if (Economy.data.unlockedTrail) { ctx.save(); ctx.globalCompositeOperation = 'lighter'; let auraSize = size * (1.2 + Math.sin(Date.now()/100)*0.1); let grad = ctx.createRadialGradient(px, py-size/2, 10, px, py-size/2, auraSize); grad.addColorStop(0, 'rgba(0, 255, 255, 0.8)'); grad.addColorStop(1, 'rgba(0, 0, 255, 0)'); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(px, py-size/2, auraSize, 0, Math.PI*2); ctx.fill(); ctx.restore(); }
        
        // SKIN LOGIC
        ctx.save();
        if (Economy.data.equippedSkin === 'shadow') { ctx.filter = "grayscale(100%) contrast(150%) brightness(0.6)"; }
        if (Economy.data.equippedSkin === 'gold') { ctx.filter = "sepia(100%) saturate(300%) brightness(1.2) hue-rotate(5deg)"; }
        
        if (Assets.images.player && Assets.images.player.complete) { ctx.shadowColor = State.isFlowState ? '#ffd700' : '#00ff00'; ctx.shadowBlur = 20; let drawH = size * squash; ctx.drawImage(Assets.images.player, px - size/2, py - drawH, size, drawH); } else { ctx.fillStyle = '#aa00ff'; ctx.fillRect(px - 30, py - 60, 60, 60); }
        ctx.restore();

        State.particles.forEach(p => { ctx.fillStyle = p.color; ctx.beginPath(); let ppx = cx + (State.player.lane - 1) * State.LANE_WIDTH_BASE * 2; ctx.arc(ppx + p.x, (canvas.height - 100) + p.y, p.size, 0, Math.PI*2); ctx.fill(); });
        State.texts.forEach(t => { ctx.font = "bold 24px Courier New"; ctx.textAlign = "center"; ctx.fillStyle = t.color; let ppx = cx + (State.player.lane - 1) * State.LANE_WIDTH_BASE * 2; ctx.fillText(t.msg, ppx, (canvas.height - 150) + t.y); });
    }

    function spawnParticles(x, y, count, color) { for(let i=0; i<count; i++) { State.particles.push({ x: x, y: y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 20, size: Math.random()*5, color: color }); } }
    function spawnFloatingText(msg, color) { State.texts.push({ msg: msg, color: color, y: -50, life: 30 }); }
    function shakeScreen() { canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`; setTimeout(() => canvas.style.transform = 'none', 200); }
    function updateHUD() { document.getElementById('score-display').innerText = `SCORE: ${Math.floor(State.score)}`; document.getElementById('hud-wallet-val').innerText = State.runEnergy; document.getElementById('multiplier-display').innerText = `x${State.flowMultiplier.toFixed(1)}`; document.getElementById('flow-fill').style.width = `${State.flowCharge}%`; }

    initGame();
</script>
</body>
</html>